<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Patient | {{ patient.full_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .detail-group {
            border-left: 3px solid var(--primary-blue);
            padding-left: 15px;
            margin-bottom: 25px;
        }
        .detail-group h4 {
            color: #9EC0FF;
            margin-bottom: 10px;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted rgba(255, 255, 255, 0.1);
        }
        .detail-label {
            font-weight: 500;
            opacity: 0.7;
        }
        .detail-value {
            font-weight: 600;
            color: var(--text-light);
        }
        .action-container {
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <h4>RehabCare+</h4>
        <a href="/dashboard">üè† Dashboard</a>
        <a href="/add_patient">‚ûï Add Patient</a>
        <a href="/patients" class="active">üßç Patients List</a>
        <a href="/rooms">üõè Rooms</a>
        <a href="/billing">üí≥ Billing</a>
        <a href="/medicine_history">üíä Medicine History</a>
        <a href="/logout">üö™ Logout</a>
    </div>

    <div class="content">
        <div class="navbar-custom">
            <span class="nav-title">Patient Profile: {{ patient.full_name }} (#{{ patient.patient_code }})</span>
            <button class="btn-outline btn-custom" onclick="toggleSidebar()">‚ò∞</button>
        </div>
        
        <div class="action-container" style="margin-top: 20px;">
            <a href="/edit_patient/{{ patient.patient_id }}" class="action-btn edit-btn" style="text-decoration: none;">‚úèÔ∏è Edit Record</a>
            <a href="/record_dose?patient_id={{ patient.patient_id }}" class="action-btn view-btn" style="text-decoration: none;">üíä Record Dose</a>
            <a href="/generate_invoice?patient_id={{ patient.patient_id }}" class="action-btn view-btn" style="background: #10B981; text-decoration: none;">üí≥ New Invoice</a>
        </div>

        <div class="row" style="display: flex; gap: 20px;">
            <div class="card-custom" style="flex: 1; padding: 25px;">
                <h3 style="margin-bottom: 20px; color: #FBBF24;">Personal & Admission Details</h3>

                <div class="detail-group">
                    <h4>Personal Information</h4>
                    <div class="detail-item"><span class="detail-label">Patient Code</span><span class="detail-value">{{ patient.patient_code }}</span></div>
                    <div class="detail-item"><span class="detail-label">Full Name</span><span class="detail-value">{{ patient.full_name }}</span></div>
                    <div class="detail-item"><span class="detail-label">Date of Birth</span><span class="detail-value">{{ patient.dob }}</span></div>
                    <div class="detail-item"><span class="detail-label">Gender</span><span class="detail-value">{{ patient.gender }}</span></div>
                    <div class="detail-item"><span class="detail-label">Branch</span><span class="detail-value">{{ patient.branch_name }}</span></div>
                </div>

                <div class="detail-group">
                    <h4>Admission & Room Status</h4>
                    <div class="detail-item"><span class="detail-label">Admission Date</span><span class="detail-value">{{ patient.admission_date }}</span></div>
                    <div class="detail-item"><span class="detail-label">Expected Discharge</span><span class="detail-value">{{ patient.expected_discharge_date }}</span></div>
                    <div class="detail-item"><span class="detail-label">Room Number</span><span class="detail-value">{{ patient.room_number if patient.room_number else 'Not Allocated' }}</span></div>
                    <div class="detail-item"><span class="detail-label">Current Status</span><span class="detail-value status-{{ patient.status | lower }}">{{ patient.status }}</span></div>
                </div>

                <div class="detail-group">
                    <h4>Guardian / Emergency Contact</h4>
                    <div class="detail-item"><span class="detail-label">Name</span><span class="detail-value">{{ patient.guardian_name }}</span></div>
                    <div class="detail-item"><span class="detail-label">Relation</span><span class="detail-value">{{ patient.guardian_relation }}</span></div>
                    <div class="detail-item"><span class="detail-label">Phone</span><span class="detail-value">{{ patient.guardian_phone }}</span></div>
                    <div class="detail-item"><span class="detail-label">Address</span><span class="detail-value">{{ patient.guardian_address if patient.guardian_address else 'N/A' }}</span></div>
                </div>
            </div>

            <div class="card-custom" style="flex: 1; padding: 25px;">
                <h3 style="margin-bottom: 20px; color: #FBBF24;">Medical & Addiction History</h3>

                <div class="detail-group">
                    <h4>Addiction Profile</h4>
                    <div class="detail-item"><span class="detail-label">Primary Drug</span><span class="detail-value">{{ patient.primary_addiction }}</span></div>
                    <div class="detail-item"><span class="detail-label">Duration of Use</span><span class="detail-value">{{ patient.duration_of_use_months }} months ({{ (patient.duration_of_use_months / 12) | round(1) }} years)</span></div>
                    <div class="detail-item"><span class="detail-label">Addiction Level</span>
                        <span class="detail-value" style="color: {% if patient.addiction_level == 'High' %}#EF4444{% elif patient.addiction_level == 'Moderate' %}#FBBF24{% else %}#10B981{% endif %}">
                            {{ patient.addiction_level }}
                        </span>
                    </div>
                </div>

                <div class="detail-group">
                    <h4>Medical Conditions</h4>
                    <div class="detail-item"><span class="detail-label">Pre-existing Diseases</span><span class="detail-value">{{ patient.diseases if patient.diseases else 'None' }}</span></div>
                    <div class="detail-item"><span class="detail-label">Known Allergies</span><span class="detail-value">{{ patient.allergies if patient.allergies else 'None' }}</span></div>
                    <div class="detail-item"><span class="detail-label">Last Donation Date</span><span class="detail-value">{{ patient.last_donation_date if patient.last_donation_date else 'N/A' }}</span></div>
                </div>

                <div class="detail-group">
                    <h4>Clinical Notes</h4>
                    <p style="color: var(--text-muted); line-height: 1.6;">{{ patient.medical_notes if patient.medical_notes else 'No notes recorded.' }}</p>
                </div>
            </div>
        </div>
        
        <div class="row" style="display: flex; gap: 20px; margin-top: 20px;">
            <div class="card-custom" style="flex: 1; padding: 25px;">
                <h3 style="margin-bottom: 20px; color: #10B981;">Billing & Invoice History</h3>
                {% if invoices %}
                <div class="table-scroll">
                    <table class="table-custom">
                        <thead>
                            <tr>
                                <th>Bill ID</th>
                                <th>Bill Date</th>
                                <th>Amount Due</th>
                                <th>Amount Paid</th>
                                <th>Balance</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bill in invoices %}
                            <tr>
                                <td>#{{ bill.bill_id }}</td>
                                <td>{{ bill.bill_date }}</td>
                                <td>PKR {{ bill.amount_due | int }}</td>
                                <td>PKR {{ bill.amount_paid | int }}</td>
                                <td>PKR {{ bill.due_amount | int }}</td>
                                <td><span class="status-{{ bill.status | lower }}">{{ bill.status }}</span></td>
                                <td><a href="/view_bill/{{ bill.bill_id }}" style="color: var(--primary-blue);">View</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p style="color: var(--text-muted); text-align: center; padding: 20px;">No billing records found.</p>
                {% endif %}
            </div>
            
            <div class="card-custom" style="flex: 1; padding: 25px;">
                <h3 style="margin-bottom: 20px; color: #3B82F6;">Recent Medication Records</h3>
                {% if medicine_records %}
                <div class="table-scroll">
                    <table class="table-custom">
                        <thead>
                            <tr><th>Date</th><th>Time</th><th>Medicine</th><th>Dosage</th><th>By</th></tr>
                        </thead>
                        <tbody>
                            {% for med in medicine_records %}
                            <tr>
                                <td>{{ med.admin_date }}</td>
                                <td>{{ med.admin_time }}</td>
                                <td>{{ med.medicine_name }}</td>
                                <td>{{ med.dosage }}</td>
                                <td>{{ med.administered_by }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p style="color: var(--text-muted); text-align: center; padding: 20px;">No medication records found.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>